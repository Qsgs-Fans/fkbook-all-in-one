写在前面
==========

所以说你最终通达了拓展制作之道，想要来做一些更酷的事情？这一部分就是为了\
让你对新月杀的了解更上一层楼而编写的哦。

这些文档的目的是带你对新月杀底层有进一步了解。当然了，不可能再像之前拓展教程\
讲的那么详细啦，咱们只挑关键的说明，更多细节就请自己在代码中寻找答案吧。

新月杀架构略图
---------------

在开始之前，让我们先对新月杀的架构有一个略微的了解吧。\
新月杀是一个C/S架构的程序，说明至少有两套架构（其实也差不多）。\
虽然代码仍然会更新，但是架构是基本不会变化的咯。

我们先看服务端的架构吧：

.. figure:: pic/1-1.jpg
   :align: center

如图，服务端以C++为基础，上方支撑着Lua和数据库。其中，Lua用来运行游戏逻辑，\
数据库（目前只能sqlite）用来保存胜率、用户信息等数据。

从多线程的角度看，服务端主要是双线程的架构。

- 主线程：负责处理用户登录、发送房间列表等与游戏无关的事情。
- Lua线程：负责所有的游戏逻辑。服务端有很多房间同时运行着，其中每个房间都\
  对应一个Lua协程。

此外还有一个心跳包线程和服务端Shell线程，这俩因为不重要就不提了。

再来看看客户端的架构：

.. figure:: pic/1-2.jpg
   :align: center

一样的，还是以C++为基础，上面是Lua和Qml/JS。Qml自然就是我们平时玩牌时用来交互\
的GUI界面了。而UI自然要调用很多很多Lua函数用来判断各种逻辑之类的，所以客户端\
理所当然也要载入Lua才行得通。

.. hint::

   在单机启动的场合中，实际上是先在本机启动一个服务端，再启动客户端并连接到\
   本机。这种情况下就是上面两张图所有要素都有了，但是注意两个Lua是分开的\
   ``lua_State`` 。

参与到新月杀本体的贡献之中
---------------------------

最开始拟定框架的时候就确定了“本体精简到只含标准包，其他拓展包作为单独仓库”。\
为了方便玩家下载，拓展包都直接放在Gitee中，不过本体本身一直在Github维护。
https://github.com/Qsgs-Fans/FreeKill

当然了，还是为了方便下载，Gitee上一样有一个本体的镜像仓库：
https://gitee.com/notify-ctrl/FreeKill 但是这个仓库的master比Github要落后，\
只在发生版本更新的时候才会同步一次。

若想贡献本体的代码，需要走Fork+PR的流程。肯定是建议在github上发起PR，\
但是实在连不上Github的话，在Gitee发起PR也行。还是建议想办法连一下Github。
